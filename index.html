<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KeyKeep</title>
  <meta name="description" content="Deterministic pseudo-randon memorable word password generator" />
  <meta name="keywords" content="password, generator, seed, domain, login" />
  <meta name="author" content="FriskyFox" />
  <meta name="theme-color" content="#1e3a8a" />
  <meta property="og:title" content="KeyKeep - Deterministic Pseudo memorable password generator" />
  <meta property="og:description"
    content="Generate secure, repeatable, and memorable passwords using just your seed and domain." />
  <meta property="og:type" content="website" />
  <meta property="og:image"
    content="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iYmxhY2siPjxwYXRoIGQ9Ik0xMiAyYTUgNSAwIDAgMC01IDV2NEg2YTIgMiAwIDAgMC0yIDJ2OWEyIDIgMCAwIDAgMiAyaDEyYTIgMiAwIDAgMCAyLTJ2LTlhMiAyIDAgMCAwLTItMkgxNlY3YTUgNSAwIDAgMC01LTV6bS0zIDVhMyAzIDAgMCAxIDYgMHY0aC02Vjd6bTMgOWEyIDIgMCAxIDEgMCA0IDIgMiAwIDAgMSAwLTR6Ii8+PC9zdmc+" />
  <meta property="og:url" content="https://zrebec.github.io/keykeep" />
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iYmxhY2siPjxwYXRoIGQ9Ik0xMiAyYTUgNSAwIDAgMC01IDV2NEg2YTIgMiAwIDAgMC0yIDJ2OWEyIDIgMCAwIDAgMiAyaDEyYTIgMiAwIDAgMCAyLTJ2LTlhMiAyIDAgMCAwLTItMkgxNlY3YTUgNSAwIDAgMC01LTV6bS0zIDVhMyAzIDAgMCAxIDYgMHY0aC02Vjd6bTMgOWEyIDIgMCAxIDEgMCA0IDIgMiAwIDAgMSAwLTR6Ii8+PC9zdmc+" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" href="apple-touch-icon.png" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <style>
    *,
    *:before,
    *:after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, #1e3a8a 0%, #111827 100%);
      color: #e5e7eb;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: clamp(1rem, 2.5vw, 1.3rem);
      min-height: 100vh;
    }

    header {
      background-color: #ffffff;
      color: #1f2937;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 10rem;
    }

    header h1 {
      font-size: 2rem;
      text-transform: uppercase;
      font-weight: 700;
    }

    header p {
      color: #4b5563;
      font-size: 1rem;
    }

    .form-container {
      max-width: 700px;
      height: calc(100vh - 10rem);
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 auto;
      padding: 1rem;
    }

    input,
    select,
    button {
      width: 100%;
      margin: 8px 0;
      border: none;
      font-size: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      color: #1f2937;
      background-color: #f3f4f6;
      transition: background-color 0.2s, box-shadow 0.2s;
    }

    label {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      color: #d1d5db;
      font-weight: 500;
    }

    input {
      padding-right: 2.5rem;
    }

    select {
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml;utf8,<svg fill='%231f2937' height='12' viewBox='0 0 24 24' width='12' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      padding-right: 2.5rem;
    }

    button {
      min-width: 48px;
      min-height: 48px;
      background-color: #2563eb;
      color: white;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    button:hover {
      background-color: #1d4ed8;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    input:focus,
    select:focus,
    button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5);
      background-color: #ffffff;
    }

    .form-field {
      width: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .form-field span {
      position: absolute;
      font-size: 2rem;
      top: 65%;
      right: 10px;
      transform: translateY(-50%);
      color: #ef4444;
    }

    .form-field__clipboard {
      flex-direction: row;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .form-field__clipboard input {
      width: 90%;
      margin-right: 0.5rem;
    }

    .form-field__clipboard button {
      width: 10%;
      background-color: #4b5563;
    }

    .form-field__clipboard button:hover {
      background-color: #374151;
    }

    @media screen and (min-width: 600px) {
      .form-container {
        justify-content: center;
        padding: 2rem;
      }

      input,
      select,
      button {
        padding: 1rem 1.5rem;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>KeyKeep</h1>
    <p>Deterministic pseudo-random memorable word password generator</p>
  </header>
  <main>
    <form id="password-form" action="javascript:void(0)" method="post">
      <div class="form-container">
        <div class="form-field">
          <label for="userSeed">Seed</label>
          <input type="text" id="userSeed" placeholder="Enter your seed here" aria-label="Seed for password generation"
            aria-required="true" />
          <span>*</span>
        </div>
        <div class="form-field">
          <label for="passwordVariation">Password variation</label>
          <select id="passwordVariation" aria-label="Select your password variation" required>
            <option value="1">Basic</option>
            <option value="2" selected>Extended</option>
          </select>
        </div>
        <div class="form-field">
          <label for="passwordDomain">Domain</label>
          <input type="text" id="passwordDomain" placeholder="Enter domain (only last 2 levels)"
            aria-label="Domain for which you want to get the password" aria-required="true" required />
          <span>*</span>
        </div>
        <div class="form-field">
          <label for="userLogin">Login</label>
          <input type="text" id="userLogin" placeholder="Enter your login (optional)" />
        </div>
        <div class="form-field">
          <label for="passwordLength">Password length</label>
          <select id="passwordLength" aria-label="Select your password length" required>
            <option value="8">8</option>
            <option value="12" selected>12</option>
            <option value="16">16</option>
            <option value="24">24</option>
          </select>
        </div>
        <div class="form-field">
          <label for="gettedPassword">Generated password</label>
          <div class="form-field__clipboard">
            <input type="text" id="gettedPassword" placeholder="Generated password will be here" readonly
              aria-label="Generated password response" />
            <button type="button" id="copyPasswordBtn" title="Copy password to clipboard"
              aria-label="Copy password to clipboard">
              ðŸ“‹
            </button>
          </div>
        </div>
        <div class="form-field">
          <button type="submit">Get Password</button>
        </div>
      </div>
    </form>
  </main>
  <script>
    // Register service worker for offline support
    /*
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js');
    }
    */

    window.onload = function () {
      document.getElementById('userSeed').focus();
    };

    async function yieldToUI() {
      return new Promise((resolve) => setTimeout(resolve, 0));
    }

    // Add keyboard accessibility for the copy button
    document.getElementById('copyPasswordBtn').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        this.click();
      }
    });

    document.getElementById('password-form').addEventListener('submit', async function (event) {
      event.preventDefault(); // Prevent form submission

      // get the selected options
      const seed = document.getElementById('userSeed').value;
      const domain = document.getElementById('passwordDomain').value;
      const login = document.getElementById('userLogin').value;
      // prettier-ignore
      const variation = parseInt(document.getElementById('passwordVariation').value);
      // prettier-ignore
      const length = parseInt(document.getElementById("passwordLength").value);

      // generate SHA256 hash
      //const hashBytes = await generateSHA256(`${seed}::${domain}::${login}`);

      // derive the key using PBKDF2
      toggleForm(true);
      console.log('Deriving key...');

      await yieldToUI(); // Yield to the UI to allow the form to update

      let salt = `${domain}::${login}::${variation}`;

      if (variation == 1) {
        salt = `${domain}::${login}`;
      }

      const key = await deriveKeyPBKDF2(seed, salt, 10000000, 256);
      console.log('Key derivated...');
      toggleForm(false);
      document.getElementById('userSeed').disabled = false;
      const keyBytes = await exportKey(key);

      // Convert the key to a byte array
      const hashBytes = new Uint8Array(keyBytes.buffer); // Convert ArrayBuffer to Uint8Array

      // Declare the charset based on the selected options
      const specials = '.,/*-';
      const numbers = '0123456789';

      // pattern for the password
      let passwordParts = [];
      let currentLength = 0;
      let hashIndex = 3;

      while (currentLength < length - 2) {
        // 3 - 5 characters long word
        const dynamicLength = 3 + (hashBytes[hashIndex] % 3); // 3â€“5 znakov
        const word = generateWord(hashBytes, hashIndex, dynamicLength);

        // add a word to the password even if we have to exceed the required password length (more rather than less)
        passwordParts.push(word);
        currentLength += word.length;
        hashIndex += dynamicLength;

        // Always add a special character if the password hasn't been significantly exceeded yet
        // We don't test exactly at the boundary - we don't mind exceeding the length
        if (hashIndex < hashBytes.length) {
          const special = specials[hashBytes[hashIndex++] % specials.length];
          passwordParts.push(special);
          currentLength += 1;
        }
      }

      let password = passwordParts.join('').slice(0, length - 2);

      // Add numbers to the end of the password
      const number1 = numbers[hashBytes[1] % numbers.length];
      const number2 = numbers[hashBytes[2] % numbers.length];
      password += `${number1}${number2}`;
      currentLength += 2;

      document.getElementById('gettedPassword').value = password;
    });

    document.getElementById('copyPasswordBtn').addEventListener('click', function () {
      const passwordField = document.getElementById('gettedPassword');
      if (!passwordField.value) return;

      navigator.clipboard
        .writeText(passwordField.value)
        .then(() => {
          this.textContent = 'âœ…'; // feedback
          setTimeout(() => (this.textContent = 'ðŸ“‹'), 1500);
        })
        .catch((err) => {
          console.error('Copy failed:', err);
        });
    });

    async function generateSHA256(input) {
      const encoder = new TextEncoder();
      const data = encoder.encode(input);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray;
    }

    // pseudo-word generator
    function generateWord(hashBytes, startIndex, wordLength = 4) {
      const vowels = 'aeiou';
      const consonants = 'bcdfghjklmnpqrstvwxz';
      let word = '';
      let useVowel = false;

      for (let i = 0; i < wordLength; i++) {
        const set = useVowel ? vowels : consonants;
        const c = set[hashBytes[startIndex + i] % set.length];
        word += c;
        const lastTwo = word.slice(-2).split('');
        const onlyConsonants = lastTwo.every((ch) => consonants.includes(ch));
        useVowel = !useVowel || onlyConsonants;
      }

      return word.charAt(0).toUpperCase() + word.slice(1); // zaÄÃ­na veÄ¾kÃ½m pÃ­smenom
    }

    // better deriveKey function using PBKDF2
    async function deriveKeyPBKDF2(password, salt, iterations = 100000, keyLength = 256) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), { name: 'PBKDF2' }, false, [
        'deriveBits',
        'deriveKey',
      ]);
      const key = await crypto.subtle.deriveKey(
        {
          name: 'PBKDF2',
          salt: enc.encode(salt),
          iterations: iterations,
          hash: 'SHA-256',
        },
        keyMaterial,
        { name: 'AES-GCM', length: keyLength },
        true,
        ['encrypt', 'decrypt'],
      );
      return key;
    }

    async function exportKey(key) {
      // Exportuje kÄ¾ÃºÄ vo formÃ¡te "raw" (ArrayBuffer)
      const rawKey = await crypto.subtle.exportKey('raw', key);
      // Prekonvertujeme ArrayBuffer na Uint8Array pre jednoduchÅ¡ie spracovanie
      const keyBytes = new Uint8Array(rawKey);
      return keyBytes;
    }

    function toggleForm(disabled = true) {
      const formElements = document.querySelectorAll('#password-form input, #password-form select, #password-form button');
      formElements.forEach((el) => {
        el.disabled = disabled;
      });
    }
  </script>
</body>

</html>